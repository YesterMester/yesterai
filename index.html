<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Chat & Code Generator â€” Robust Puter / OpenAI Fallback</title>
  <style>
    /* Visuals (kept compact but familiar) */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:18px}
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.96);border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.12);overflow:hidden}
    .header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;gap:12px}
    .header h1{font-size:1.4rem;margin-bottom:4px}
    .header p{margin:0;opacity:.95;font-size:.95rem}
    .status{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.12);font-size:.9rem}
    .main{display:grid;grid-template-columns:300px 1fr;min-height:620px}
    .sidebar{padding:18px;border-right:1px solid #e6eef8;background:#fbfdff}
    .chatwrap{display:flex;flex-direction:column;height:100%}
    .models h3{margin-bottom:8px;font-size:1rem}
    .model-category{color:#4f46e5;font-weight:700;margin-top:12px;margin-bottom:8px;font-size:.85rem}
    .model-option{background:#fff;border:2px solid #e8eef8;border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer;transition:all .15s;display:block}
    .model-option:hover{transform:translateY(-2px);border-color:#4f46e5}
    .model-option.active{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;border-color:#4f46e5}
    .model-name{font-weight:600}
    .model-desc{font-size:.82rem;opacity:.85}
    .quick-prompts{margin-top:12px}
    .quick-prompts button{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;background:#fff;margin-bottom:8px;cursor:pointer}
    .api-controls{margin-top:12px;padding:10px;border-radius:8px;background:#fff;border:1px solid #eef6ff}
    .api-controls textarea{width:100%;height:44px;padding:8px;border-radius:6px;border:1px solid #e6eef8;resize:vertical}
    .api-actions{display:flex;gap:8px;margin-top:8px}
    .api-actions button{flex:1;padding:8px;border-radius:8px;border:none;cursor:pointer}
    .save-btn{background:#4f46e5;color:#fff}
    .clear-btn{background:#fff;border:1px solid #e6eef8}
    .messages{padding:20px;background:#fff;overflow:auto;flex:1}
    .message{margin-bottom:16px;padding:12px;border-radius:12px;max-width:82%;animation:slide .18s ease}
    @keyframes slide{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .user-message{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;margin-left:auto;border-bottom-right-radius:6px}
    .ai-message{background:#f1f5f9;color:#0f172a;border-left:4px solid #4f46e5;border-bottom-left-radius:6px}
    .code-block{background:#0f1722;color:#e6eef8;padding:12px;border-radius:8px;margin-top:8px;font-family:monospace;position:relative;overflow:auto}
    .copy-btn{position:absolute;top:8px;right:8px;background:#4f46e5;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    .input-area{padding:14px;border-top:1px solid #eef6ff;background:#fbfdff;display:flex;gap:10px;align-items:center}
    .message-input{flex:1;padding:12px 14px;border-radius:22px;border:2px solid #e6eef8;font-size:1rem}
    .send-btn{padding:11px 16px;border-radius:22px;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;border:none;cursor:pointer;font-weight:600}
    .send-btn[disabled]{opacity:.6;cursor:not-allowed}
    .loading{display:flex;gap:10px;align-items:center;color:#64748b}
    .spinner{width:18px;height:18px;border:2px solid #e8eef8;border-top:2px solid #4f46e5;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{background:#fff6f6;color:#7f1d1d;border-left:4px solid #ef4444}
    .muted{font-size:.85rem;color:#475569;margin-top:8px}
    @media (max-width:820px){.main{grid-template-columns:1fr}.sidebar{border-right:none;border-bottom:1px solid #eef6ff}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ðŸ¤– AI Chat & Code Generator</h1>
        <p style="margin-top:6px;opacity:.95">Puter.js attempt â†’ OpenAI key fallback â†’ Demo responses</p>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div id="statusBadge" class="status">Startingâ€¦</div>
        <div class="muted" style="text-align:right">Tip: For real OpenAI use a server-side proxy; client keys are insecure.</div>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <div class="models">
          <h3>ðŸ§  Choose AI Model</h3>

          <div class="model-category">ðŸŒŸ Premium Models</div>
          <div class="model-option active" data-model="claude-opus-4.1"><div class="model-name">Claude Opus 4.1 ðŸ”¥</div><div class="model-desc">Opus family - powerful</div></div>
          <div class="model-option" data-model="gpt-4-turbo"><div class="model-name">GPT-4 Turbo</div><div class="model-desc">OpenAI fast premium</div></div>
          <div class="model-option" data-model="gpt-4o"><div class="model-name">GPT-4o</div><div class="model-desc">Reasoning & code</div></div>

          <div class="model-category">ðŸ¤– Claude Family</div>
          <div class="model-option" data-model="claude-3.5-sonnet"><div class="model-name">Claude 3.5 Sonnet</div></div>
          <div class="model-option" data-model="claude-3-opus"><div class="model-name">Claude 3 Opus</div></div>

          <div class="model-category">ðŸš€ OpenAI Models</div>
          <div class="model-option" data-model="gpt-4"><div class="model-name">GPT-4</div></div>
          <div class="model-option" data-model="gpt-3.5-turbo"><div class="model-name">GPT-3.5 Turbo</div></div>

          <div class="model-category">âš¡ Other</div>
          <div class="model-option" data-model="llama-3-70b"><div class="model-name">Llama 3 70B</div></div>
        </div>

        <div class="quick-prompts" style="margin-top:12px">
          <h3>âš¡ Quick Actions</h3>
          <button onclick="setPrompt('Create a Python function to')">Python Code</button>
          <button onclick="setPrompt('Build a React component that')">React Component</button>
          <button onclick="setPrompt('Write HTML/CSS for')">Web Design</button>
        </div>

        <div class="api-controls">
          <div style="display:flex;align-items:center;gap:8px">
            <strong>OpenAI Key</strong>
            <button id="pasteKey" style="padding:6px;border-radius:8px;border:1px solid #e6eef8;background:#fff;cursor:pointer">Paste</button>
          </div>
          <textarea id="openaiKey" placeholder="sk-... (optional, client-side testing only)"></textarea>
          <div class="api-actions">
            <button id="saveKey" class="save-btn">Save Key (local)</button>
            <button id="clearKey" class="clear-btn">Clear</button>
          </div>
          <div class="muted">Saved locally for convenience only. Server-proxy recommended for production.</div>
        </div>
      </div>

      <div class="chatwrap">
        <div id="messages" class="messages">
          <div class="message ai-message">ðŸ‘‹ Welcome â€” select a model and ask for code, debugging, or explanations.</div>
        </div>

        <div class="input-area">
          <input id="messageInput" class="message-input" type="text" placeholder="Ask for code, debugging, or anything..." onkeypress="handleKeyPress(event)" autocomplete="off" />
          <button id="sendBtn" class="send-btn" onclick="sendMessage()">Send ðŸš€</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ============================
     Robust AI Chat â€” Single File
     - Attempts Puter.js from common URLs
     - Robustly extracts text from many response shapes
     - Falls back to OpenAI (client key) if provided
     - Falls back to simulated demo responses otherwise
     ============================ */

  // ---------- State ----------
  let currentModel = 'claude-opus-4.1';
  let isLoading = false;
  let puter = null;
  const OPENAI_STORAGE_KEY = 'chat_openai_key_v1';
  const statusBadge = document.getElementById('statusBadge');

  // ---------- UI helpers ----------
  function setStatus(text, style) {
    statusBadge.textContent = text;
    if (style) statusBadge.style.background = style;
    else statusBadge.style.background = 'rgba(255,255,255,.12)';
  }

  function escapeHtml(s) {
    const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML;
  }

  function addMessage(sender, content, isError = false, isLoadingMsg = false) {
    const container = document.getElementById('messages');
    const msg = document.createElement('div');
    const id = 'm_' + Date.now() + '_' + Math.floor(Math.random()*1000);
    msg.id = id;

    if (isLoadingMsg) {
      msg.className = 'message ai-message loading';
      msg.innerHTML = '<div class="spinner"></div><span style="margin-left:10px">AI is thinking...</span>';
    } else {
      msg.className = 'message ' + (sender === 'user' ? 'user-message' : 'ai-message') + (isError ? ' error' : '');
      msg.innerHTML = formatMessage(content);
      // attach copy buttons
      msg.querySelectorAll('.code-block').forEach(block => {
        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Copy';
        btn.onclick = () => copyCode(block, btn);
        block.appendChild(btn);
      });
    }

    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
    return id;
  }

  function removeMessage(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }

  function formatMessage(text) {
    if (!text && text !== 0) return '';
    // treat text as string or object
    let s = (typeof text === 'string') ? text : JSON.stringify(text, null, 2);
    // convert code fences
    s = s.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, code) => {
      return `<div class="code-block"><pre><code>${escapeHtml(code.trim())}</code></pre></div>`;
    });
    // inline code
    s = s.replace(/`([^`]+)`/g, '<code style="background:#eef2ff;padding:2px 6px;border-radius:4px;">$1</code>');
    // convert newlines to <br> for non-code parts
    // but avoid converting inside code-blocks â€” we already placed them
    // For safety: replace remaining newlines with <br>
    s = s.replace(/\n/g, '<br>');
    return s;
  }

  function copyCode(block, btn) {
    const codeEl = block.querySelector('code');
    if (!codeEl) return;
    const text = codeEl.textContent;
    navigator.clipboard.writeText(text).then(() => {
      const prev = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = prev, 1500);
    }).catch(() => alert('Copy failed'));
  }

  function handleKeyPress(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  // ---------- Safe stringify (circular-safe) ----------
  function getCircularReplacer() {
    const seen = new WeakSet();
    return (k, v) => {
      if (typeof v === 'object' && v !== null) {
        if (seen.has(v)) return '[Circular]';
        seen.add(v);
      }
      return v;
    };
  }
  function safeStringify(obj, maxLen = 4000) {
    try {
      return JSON.stringify(obj, getCircularReplacer(), 2).slice(0, maxLen);
    } catch (e) {
      try { return String(obj).slice(0, maxLen); } catch (e2) { return '[unserializable]'; }
    }
  }

  // ---------- Robust extractor for many provider response shapes ----------
  function extractTextFromResponse(resp) {
    if (resp == null) return '';
    if (typeof resp === 'string') return resp;
    // Common locations to try (ordered)
    const paths = [
      ['choices',0,'message','content'],
      ['choices',0,'text'],
      ['output_text'],
      ['result','content'],
      ['result','response','content',0,'text'],
      ['content'],
      ['message','content'],
      ['data',0,'text'],
      ['outputs',0,'content',0,'text'],
      ['output',0,'content',0,'text'],
      ['response','text'],
      ['output_texts'],
      ['answer'],
      ['body','text']
    ];
    const dig = (o, p) => {
      try {
        for (const k of p) {
          if (o == null) return undefined;
          o = o[k];
        }
        return o;
      } catch (e) { return undefined; }
    };

    for (const p of paths) {
      const v = dig(resp, p);
      if (v == null) continue;
      if (typeof v === 'string' && v.trim() !== '') return v;
      if (Array.isArray(v)) {
        const joined = v.map(x => (typeof x === 'string' ? x : (x?.text || safeStringify(x,1000)))).join('\n');
        if (joined.trim() !== '') return joined;
      }
    }

    // Support: outputs array with content pieces
    if (Array.isArray(resp.outputs)) {
      const parts = [];
      resp.outputs.forEach(o => {
        if (!o) return;
        if (typeof o === 'string') parts.push(o);
        if (o.content) {
          if (Array.isArray(o.content)) {
            o.content.forEach(c => {
              if (typeof c === 'string') parts.push(c);
              else if (c?.text) parts.push(c.text);
              else parts.push(safeStringify(c,1000));
            });
          } else {
            parts.push(safeStringify(o.content,1000));
          }
        }
      });
      if (parts.length) return parts.join('\n\n');
    }

    // shallow search for string fields
    const stringsFound = [];
    (function hunt(o, depth=0) {
      if (!o || typeof o !== 'object' || depth>6) return;
      for (const k of Object.keys(o)) {
        try {
          const v = o[k];
          if (typeof v === 'string' && v.trim()) stringsFound.push(v);
          else if (typeof v === 'object') hunt(v, depth+1);
        } catch (e) {}
        if (stringsFound.length >= 6) return;
      }
    })(resp);
    if (stringsFound.length) return stringsFound.join('\n\n');

    // fallback to JSON dump
    return safeStringify(resp, 3000);
  }

  // ---------- Puter loader (tries multiple URLs) ----------
  function loadScript(url, timeout=4000) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = url;
      s.async = true;
      s.onload = () => resolve(true);
      s.onerror = () => reject(new Error('Load failed: ' + url));
      document.head.appendChild(s);
      if (timeout) setTimeout(()=> reject(new Error('Timeout loading ' + url)), timeout);
    });
  }

  async function tryInitPuter() {
    const candidates = [
      'https://js.puter.com/v2/',
      'https://js.puter.com/v2/puter.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/puter/2.0.0/puter.min.js'
    ];
    for (const url of candidates) {
      try {
        await loadScript(url, 3500);
        await new Promise(r => setTimeout(r, 250));
        if (window.puter) {
          // try to initialize if init fn exists
          try {
            if (typeof window.puter.init === 'function') {
              const maybe = await window.puter.init().catch(e=>{ console.warn('puter.init err',e); return null; });
              puter = maybe || window.puter;
            } else puter = window.puter;
          } catch(e) {
            puter = window.puter || null;
          }
          if (puter) return true;
        }
      } catch (e) {
        console.warn('Puter load fail', url, e);
      }
    }
    return false;
  }

  // ---------- OpenAI client (client-side, insecure; only for testing) ----------
  const openaiModelMap = {
    'gpt-4':'gpt-4',
    'gpt-4o':'gpt-4o',
    'gpt-4-turbo':'gpt-4o',
    'gpt-3.5-turbo':'gpt-3.5-turbo'
  };

  async function callOpenAI(message, chosenModel) {
    const key = (document.getElementById('openaiKey').value || localStorage.getItem(OPENAI_STORAGE_KEY) || '').trim();
    if (!key) throw new Error('No OpenAI key found (paste it into the sidebar)');
    const model = openaiModelMap[chosenModel] || 'gpt-3.5-turbo';
    const payload = { model, messages: [{ role: 'user', content: message }], max_tokens: 1200, temperature: 0.2 };
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers:{ 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const errTxt = await res.text().catch(()=>res.statusText);
      throw new Error('OpenAI error: ' + res.status + ' ' + errTxt);
    }
    const d = await res.json();
    // typical path: d.choices[0].message.content
    return extractTextFromResponse(d);
  }

  // ---------- Demo simulator ----------
  async function simulateAIResponse(message, model) {
    await new Promise(r => setTimeout(r, 700 + Math.random()*900));
    const lower = message.toLowerCase();
    if (lower.includes('python') || lower.includes('function')) {
      return `Here's a Python function (generated by ${model}):\n\n\`\`\`python\ndef example(x):\n    return x * 2\n\nprint(example(5))  # 10\n\`\`\``;
    }
    if (lower.includes('react') || lower.includes('component')) {
      return `\`\`\`jsx\nimport React from 'react';\nexport default function Example(){\n  return <div>Hello from ${model}</div>\n}\n\`\`\``;
    }
    if (lower.includes('html') || lower.includes('css')) {
      return `\`\`\`html\n<div class="card">Hello from ${model}</div>\n\`\`\``;
    }
    return `I'm ${model} (demo). Tell me what you want: code, debugging help, or an explanation.`;
  }

  // ---------- Main send handler (robust) ----------
  async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = (input.value || '').trim();
    if (!text || isLoading) return;

    addMessage('user', escapeHtml(text));
    input.value = '';
    isLoading = true;

    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Thinking...';

    const loadingId = addMessage('ai', '', false, true);

    try {
      let aiText = '';

      if (puter && puter.ai && typeof puter.ai.chat === 'function') {
        setStatus('Using Puter.ai', 'linear-gradient(90deg,#10b981,#06b6d4)');
        // Call puter.ai.chat â€” SDKs vary, catch any shape
        let puterResp;
        try {
          puterResp = await puter.ai.chat({
            model: currentModel,
            messages: [{ role: 'user', content: text }]
          });
        } catch (e) {
          // Some puter builds expose a different call signature â€” try generic call
          try { puterResp = await puter.chat({ model: currentModel, input: text }); } catch (e2) { puterResp = { error: safeStringify(e) }; }
        }
        aiText = extractTextFromResponse(puterResp);
        if (!aiText || !String(aiText).trim()) aiText = safeStringify(puterResp, 3000);
      } else {
        // OpenAI path if key present
        const keyInBox = (document.getElementById('openaiKey').value || localStorage.getItem(OPENAI_STORAGE_KEY) || '').trim();
        if (keyInBox) {
          setStatus('Using OpenAI key', 'linear-gradient(90deg,#06b6d4,#60a5fa)');
          aiText = await callOpenAI(text, currentModel);
        } else {
          setStatus('Demo (simulated)', 'linear-gradient(90deg,#f97316,#fb923c)');
          aiText = await simulateAIResponse(text, currentModel);
        }
      }

      removeMessage(loadingId);
      addMessage('ai', aiText);
    } catch (err) {
      console.error('sendMessage error', err);
      removeMessage(loadingId);
      addMessage('ai', 'Error: ' + safeStringify(err, 2000), true);
      setStatus('Error â€” see console', 'linear-gradient(90deg,#ef4444,#f97316)');
    } finally {
      isLoading = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send ðŸš€';
      document.getElementById('messageInput').focus();
    }
  }

  // ---------- Wire UI interactions ----------
  function initializeModelButtons() {
    document.querySelectorAll('.model-option').forEach(opt => {
      opt.addEventListener('click', () => {
        document.querySelectorAll('.model-option').forEach(o=>o.classList.remove('active'));
        opt.classList.add('active');
        currentModel = opt.dataset.model;
        addMessage('ai', `Switched to ${opt.querySelector('.model-name')?.textContent || currentModel}. How can I help?`);
      });
    });
  }

  // ---------- Key UI ----------
  document.getElementById('saveKey').addEventListener('click', () => {
    const v = document.getElementById('openaiKey').value.trim();
    if (!v) { alert('Paste your OpenAI key before saving.'); return; }
    localStorage.setItem(OPENAI_STORAGE_KEY, v);
    alert('OpenAI key saved locally (browser localStorage). Recommended: use a server proxy in production.');
    setStatus('OpenAI key saved', 'linear-gradient(90deg,#06b6d4,#60a5fa)');
  });
  document.getElementById('clearKey').addEventListener('click', () => {
    localStorage.removeItem(OPENAI_STORAGE_KEY);
    document.getElementById('openaiKey').value = '';
    setStatus('OpenAI key cleared', 'linear-gradient(90deg,#f97316,#fb923c)');
  });
  document.getElementById('pasteKey').addEventListener('click', async () => {
    try {
      const txt = await navigator.clipboard.readText();
      document.getElementById('openaiKey').value = txt.trim();
      setStatus('Pasted key', 'linear-gradient(90deg,#60a5fa,#06b6d4)');
    } catch (e) {
      alert('Clipboard access denied â€” paste manually.');
    }
  });

  // ---------- Boot sequence ----------
  window.addEventListener('load', async () => {
    setStatus('Loading Puter...', 'rgba(255,255,255,.12)');
    initializeModelButtons();
    // load saved key to textarea
    const saved = localStorage.getItem(OPENAI_STORAGE_KEY);
    if (saved) document.getElementById('openaiKey').value = saved;

    // Attempt to load Puter, but don't fail catastrophically if it's unavailable
    const got = await tryInitPuter().catch(e => { console.warn('puter init error', e); return false; });
    if (got && puter) {
      setStatus('Puter ready', 'linear-gradient(90deg,#10b981,#06b6d4)');
      console.log('Puter available:', puter);
    } else {
      // not available â€” show fallback state
      if (localStorage.getItem(OPENAI_STORAGE_KEY) || document.getElementById('openaiKey').value.trim()) {
        setStatus('No Puter â€” OpenAI key available', 'linear-gradient(90deg,#06b6d4,#60a5fa)');
      } else {
        setStatus('Demo mode (no Puter, no OpenAI key)', 'linear-gradient(90deg,#f97316,#fb923c)');
      }
      console.warn('Puter not available â€” falling back to OpenAI/demo');
    }

    // small UX: focus input
    const input = document.getElementById('messageInput');
    if (input) input.focus();
  });

  // expose sendMessage globally (so inline onclick works)
  window.sendMessage = sendMessage;
  window.handleKeyPress = handleKeyPress;
  window.setPrompt = (p) => { document.getElementById('messageInput').value = p; document.getElementById('messageInput').focus(); };

  </script>
</body>
</html>